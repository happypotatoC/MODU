<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{index}">

<head>
	<meta charset="UTF-8">
	<title>postList</title>
	<!-- <link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/bootstrap.css">
	<link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
	<link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
	<link rel="stylesheet" href="assets/css/app.css">
	<link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon"> -->
</head>

<body>
	<div layout:fragment="content">
		<div class="buttons">
			<a class="btn btn-primary" th:href="@{postInsert(brdUniNo=${brdUniNo})}" >글작성</a>
			<!-- data-bs-toggle="modal" data-bs-target="#insertPostForm"-->
		</div>
		<hr>
		<div th:if="${#lists.isEmpty(postList)}">게시글이없습니다</div> <!--게시글없을때-->
		<div th:unless="${#lists.isEmpty(postList)}"> <!--게시글있을때-->
			<!--공지등록된게시글이있을때-->
			<div class="notiPosts"><ul></ul></div>
			
			<!--start of 게시글List-->
			<div class="col-md-10 col-sm-12 mx-auto">
				<div th:each="post : ${postList}" class="card postPlace">
					<div class="card-content">
						<div class="card-body">
							<input class="getPostUniNo" type="hidden"	th:value="${post.postUniNo}">
							<div class="row">
								<h4 class="card-title col" th:id="${post.postUniNo}">[[${post.ttl}]]</h4>
			
								<small class="text-muted">[[${post.nnm}]]</small>
							</div>
							<div class="row">
								<div class="dropdown">
									<button class="btn btn-primary dropdown-toggle me-1" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
									<div class="postDDM dropdown-menu" th:data-postUniNo="${post.postUniNo}" aria-labelledby="dropdownMenuButton">
										<th:block th:if="${post.postUniNo != null && post.postUniNo != ''}"> 						
											<a class="dropdown-item bm" th:onclick="PostBm()" th:id="${post.postUniNo}">즐겨찾기 해제</a>
										</th:block>
										<th:block th:unless="${post.postUniNo != null && post.postUniNo != ''}">									
											<a class="dropdown-item bm" th:onclick="PostBm()" th:id="${post.postUniNo}">즐겨찾기</a>
										</th:block>
										<a class="dropdown-item" th:if="${post.notiYn} == 'X'" href="#">공지등록</a>
										<a class="dropdown-item" th:if="${post.notiYn} == 'O'" href="#">공지등록해제</a>
										<a th:if="${post.particiMembUniNo} == ${session.particiMembUniNo} and ${post.replyArmYn} == 'N'" class="dropdown-item" href="#">댓글알림ON</a>
										<a th:if="${post.particiMembUniNo} == ${session.particiMembUniNo} and ${post.replyArmYn} == 'Y'" class="dropdown-item" href="#">댓글알림OFF</a>
										<a th:if="${post.particiMembUniNo} == ${session.particiMembUniNo}" class="dropdown-item" th:href="@{postUpdate(postUniNo=${post.postUniNo})}">수정</a> 
										<a th:if="${post.particiMembUniNo} == ${session.particiMembUniNo}" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#deletePost" onclick="callDeletePostModal(event)">삭제</a>
									</div>
									<hr>
									<p class="card-text">[[${post.cm}]]</p>
									<p class="card-text">[[${post.postTagArm}]]</p>
									<small class="text-muted">[[${#dates.format(post.writeDt,'yyyy-MM-dd')}]]</small>
								</div>
								첨부파일미리보기xxx아직안됨
							</div>
							<hr>
							<div class="replyPlace card-body" th:data-postUniNo="${post.postUniNo}"></div>
							<hr>
							<div class="form-group position-relative has-icon-right">
								<input name="replyUniNo" type="hidden" class="replyInput form-control" id="replyId"> 
								<input name="postUniNo" type="hidden" th:value="${post.postUniNo}" class="replyInput form-control"> 
								<input name="cntn" type="text" class="replyInput form-control" placeholder="reply">
								<div class="form-control-icon">
									<svg class="replyBtn bi" width="1em" height="1em" fill="currentColor">
										<use xlink:href="assets/vendors/bootstrap-icons/bootstrap-icons.svg#reply" />
									</svg>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--end of 게시글List-->

			<!--start of MODALS -->
				<!-- start of 게시글 작성 모달 -->
		
				<!-- end of 게시글 작성 모달 -->

				<!-- start of 게시글 삭제 모달 -->
				<div class="modal fade text-left" id="deletePost" tabindex="-1"	role="dialog" aria-labelledby="myModalLabel160"	aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
						<div class="modal-content">
							<div class="modal-header bg-primary">
								<h5 class="modal-title white" id="myModalLabel160">게시글	삭제</h5>
								<button type="button" class="close" data-bs-dismiss="modal"	aria-label="Close">
									<i data-feather="x"></i>
								</button>
							</div>
							<div class="modal-body">
								이 페이지를 삭제하시겠습니까?<br> 삭제하시면 복구 할 수 없습니다. 
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-light-secondary"	data-bs-dismiss="modal">
									<i class="bx bx-x d-block d-sm-none"></i> 
									<span	class="d-none d-sm-block">취소</span>
								</button>
								<button id="deleteBtn" type="button" class="btn btn-primary ml-1" data-bs-dismiss="modal">
									<i class="bx bx-check d-block d-sm-none"></i> 
									<span class="d-none d-sm-block">확인</span>
								</button>
							</div>
						</div>
					</div>
				</div>
				<!-- end of 게시글 삭제 모달 -->

				<!-- start of 댓글 삭제 모달 -->
				<div class="modal fade text-left" id="deleteReply" tabindex="-1"	role="dialog" aria-labelledby="myModalLabel160" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
						<div class="modal-content">
							<div class="modal-header bg-primary">
								<h5 class="modal-title white" id="myModalLabel160">댓글	삭제</h5>
								<button type="button" class="close" data-bs-dismiss="modal"	aria-label="Close">
									<i data-feather="x"></i>
								</button>
							</div>
							<div class="modal-body">
								이 페이지를 삭제하시겠습니까?<br> 삭제하시면 복구 할 수 없습니다. 
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-light-secondary"	data-bs-dismiss="modal">
									<i class="bx bx-x d-block d-sm-none"></i> 
									<span	class="d-none d-sm-block">취소</span>
								</button>
								<button id="deleteReplyBtn" type="button"	class="btn btn-primary ml-1" data-bs-dismiss="modal">
									<i class="bx bx-check d-block d-sm-none"></i> 
									<span class="d-none d-sm-block">확인</span>
								</button>
							</div>
						</div>
					</div>
				</div>
				<!--end of 댓글 삭제 모달 -->

				<!--start of 댓글수정모달 -->
				<div class="modal fade text-left" id="updateReply" tabindex="-1"	role="dialog" aria-labelledby="myModalLabel160" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"	role="document">
						<div class="modal-content">
							<div class="modal-header bg-primary">
								<h5 class="modal-title white" id="myModalLabel160">댓글 수정</h5>
								<button type="button" class="close" data-bs-dismiss="modal"	aria-label="Close">
									<i data-feather="x"></i>
								</button>
							</div>
							<div class="modal-body">
								<form action="replyUpdate" method="POST">
									<div class="modal-body">
											댓글:
											<div id="updateReplyForm"></div>
											<div>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
											<i class="bx bx-x d-block d-sm-none"></i>
											<span class="d-none d-sm-block">취소</span>
										</button>
										<button type="button" id="updateReplyBtn" class="btn btn-primary ml-1" data-bs-dismiss="modal">
											<i class="bx bx-check d-block d-sm-none"></i>
											<span class="d-none d-sm-block">수정</span>
										</button>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
				<!--end of 댓글수정모달 -->
			<!--end of MODALS -->
		<script>
				console.log('asdasdasdd'+[[${postList}]])
				//댓글리스트
				function showReplyList() {
					let getPnum = document.querySelectorAll('.getPostUniNo');
					let user = '[[${session.particiMembUniNo}]]';
					//console.log(user);
					
					getPnum.forEach(gNum => {
					let pNum = gNum.value;

					fetch('http://localhost:80/modu/replys/' + pNum)
						.then(resolve => resolve.json())
						.then(data => {
							//console.log(data);
							let rPlaceList = document.querySelectorAll('.replyPlace');

							rPlaceList.forEach(rPlace => {
								if (rPlace.dataset.postunino === pNum) {
									
									rPlace.innerHTML = '';

									data.forEach(reply => {
										if (reply.postUniNo == pNum) {
											let h5Tag = document.createElement('h5');
											h5Tag.setAttribute('class', 'card-title col');
											h5Tag.textContent = reply.nnm;
											rPlace.append(h5Tag);

											//start of reply-dropdown
											if(user == reply.particiMembUniNo){
												let divTag = document.createElement('div');
												divTag.setAttribute('class', 'dropdown');

												let btnTag = document.createElement('button');
												btnTag.setAttribute('class', 'btn btn-primary btn-sm dropdown-toggle');
												btnTag.setAttribute('data-bs-toggle', 'dropdown');
												btnTag.setAttribute('aria-haspopup', 'true');
												btnTag.setAttribute('aria-expanded', 'false');
												btnTag.textContent = '...'
												divTag.append(btnTag);
											
												let divTagDM = document.createElement('div');
												divTagDM.setAttribute('class', 'dropdown-menu');
												divTagDM.setAttribute('data-replyunino', reply.replyUniNo)
												divTag.append(divTagDM);
												
												aTag = document.createElement('a');
												aTag.setAttribute('class','dropdown-item');
												aTag.setAttribute('class','dropdown-item');
												aTag.setAttribute('data-bs-toggle','modal');
												aTag.setAttribute('data-bs-target','#updateReply');
												aTag.addEventListener('click', callOneReply);
												//document.getElementById('updateReplyUniNo').value=reply.replyUniNo;
												aTag.textContent='수정';
												divTagDM.append(aTag);
												divTag.append(divTagDM);

												aTag = document.createElement('a');
												aTag.setAttribute('class','dropdown-item');
												aTag.setAttribute('data-bs-toggle','modal');
												aTag.setAttribute('data-bs-target','#deleteReply');
												aTag.addEventListener('click', callDeleteModal);
												//document.getElementById('replyUniNo').value=reply.replyUniNo;
												aTag.textContent='삭제';
												divTagDM.append(aTag);
												divTag.append(divTagDM);
												rPlace.append(divTag);
												
												
												
												
											}
											//end of reply-dropdown 

											let pTag = document.createElement('p');
											pTag.setAttribute('class', 'card-text');
											pTag.textContent = '댓글내용 : ' + reply.cntn;
											rPlace.append(pTag);

											let smallTag = document.createElement('small');
											smallTag.setAttribute('class', 'text-muted');
											smallTag.textContent = reply.writeDt;
											rPlace.append(smallTag);
										}
									});
								}
							});
						})
						.catch(err => console.log(err));
					});
				}
			//댓글리스트 호출
			showReplyList();

			//댓글input박스 입력시 아이콘변경
			let reInputList = document.querySelectorAll('.replyInput');
			reInputList.forEach(reIn => {
				if(reIn.name == 'cntn'){
					reIn.addEventListener('input', function(){
						document.getElementsByTagName('use')[0].setAttribute('xlink:href','assets/vendors/bootstrap-icons/bootstrap-icons.svg#reply-fill')
					})
				}
			})
			//댓글입력
			let reBtnList = document.querySelectorAll('.replyBtn');
			reBtnList.forEach(btn => {
				btn.addEventListener('click', function(){
					let pNum = btn.parentElement.previousElementSibling.previousElementSibling.value;
					let replyInfo = {};
					let btnParent = btn.parentElement.parentElement;
					let rInput = btnParent.querySelectorAll('.replyInput');
					rInput.forEach(reply =>{
						replyInfo[reply.name] = reply.value;
					})
					replyInfo["postUniNo"] = pNum;
					
					fetch('http://localhost:80/modu/replyInsert',{
						method : 'post',
						headers : {
							'content-type' : 'application/json'
						},
						body : JSON.stringify(replyInfo)
					})
					.then(result => result.json())
					.then(data => {
						//rInput.value = '';
					showReplyList()
					})
					.catch(err => console.log(err))
				})
			})

			//댓글삭제
			function callDeleteModal(e){
				let rNum = e.target.parentElement.dataset.replyunino;
				document.getElementById('deleteReplyBtn').addEventListener('click', function(e){
					fetch('http://localhost:80/modu/replyDelete/'+rNum)
					//.then(resolve => resolve.json())
					.then(data => {
						showReplyList()
					})
					.catch(err => console.log(err))
				})
			}

			//댓글수정폼
			function callOneReply(e){
				//console.log(e.target.parentElement.dataset.replyunino);
				let rNum = e.target.parentElement.dataset.replyunino;
				fetch('http://localhost:80/modu/reply/' + rNum)
				.then(resolve => resolve.json())
				.then(data => {
					updateReplyForm.innerHTML = '';
					
						let inputTag = document.createElement('input');
						inputTag.setAttribute('name', 'replyUniNo');
						inputTag.value = data.replyUniNo;
						inputTag.setAttribute('type', 'hidden');
						document.getElementById('updateReplyForm').append(inputTag);

						let replyCntn = document.createElement('textarea');
						replyCntn.setAttribute('class', 'form-control');
						replyCntn.setAttribute('id', 'exampleFormControlTextarea1');
						replyCntn.setAttribute('name', 'cntn')
						replyCntn.setAttribute('rows', 4);
						replyCntn.value = data.cntn;
						document.getElementById('updateReplyForm').append(replyCntn);
				})
				.catch(err => console.log(err))
			}

			//댓글수정
			document.getElementById('updateReplyBtn').addEventListener('click', function(){
				let inputList = document.getElementById('updateReplyForm').querySelectorAll('input');
				let replyInfo = {};
				inputList.forEach(reply => {
					replyInfo[reply.name] = reply.value;
				})
				let cntn = document.getElementById('updateReplyForm').children[1];
				replyInfo['cntn'] = cntn.value;
				//console.log(replyInfo);
				fetch('http://localhost:80/modu/replyUpdate',{
					method : 'post',
					headers : {
						'content-type' : 'application/json'
					},
					body : JSON.stringify(replyInfo)
				})
				.then(result => result.json())
				.then(data => {
					//console.log(data);
					showReplyList()
				})
				.catch(err => console.log(err))
			})

			// //게시글등록
			// document.getElementById('postInsertBtn').addEventListener('click', function(){
			// 	let brdUniNo = document.getElementById('formBrdNo').value;
			// 	let ttl = document.getElementById('formTtl').value;
			// 	let cm = document.getElementById('formCm').value;
			// 	let postTagArm = document.getElementById('formCall').value;
			// 	let files = document.getElementById('attFile').files;
			// 	//let attFiles = files.split(',');
			// 	//일단여기까지? + 파일첨부기능넣을것

			// 	//file객체로 받아서

			// 	//console.log(document.getElementById('attFile').value);
			// 	//console.log(typeof(document.getElementById('attFile').value));

			// 	let postInfo = {};
			// 	postInfo['brdUniNo'] = brdUniNo;
			// 	postInfo['ttl'] = ttl;
			// 	postInfo['cm'] = cm;
			// 	postInfo['postTagArm'] = postTagArm;
			// 	postInfo['attFiles'] = JSON.stringify(files[0]);

			// 	console.log(postInfo);
			// 	console.log(files);
			// 	fetch("http://localhost:80/modu/postInsert",{
			// 		method : 'post',
			// 		headers : {
			// 			'content-type' : 'application/json'
			// 		},
			// 		body : JSON.stringify(postInfo)
			// 	})
			// 	.then(result => result.json())
			// 	.then(data => {
			// 		console.log(data);
			// 		//리다이렉트하기
			// 	})
			// })
			// //멤버호출용리스트
			// function callMembList(){
			// 	let bNum = '[[${brdUniNo}]]';
			// 	let user = '[[${session.particiMembUniNo}]]';
			// 	fetch("http://localhost:80/modu/brdMembs/" + bNum)
			// 	.then(resolve => resolve.json())
			// 	.then(data => {
			// 		//console.log(data);
			// 		data.forEach(memb => {
			// 			if(user != memb.particiMembUniNo){
			// 			let optionTag = document.createElement('option');
			// 			optionTag.setAttribute('value', memb.particiMembUniNo);
			// 			optionTag.textContent = memb.nnm;
			// 			document.getElementById('formCall').append(optionTag);
			// 			}
			// 		})
			// 	})
			// }
			// callMembList();

			//게시글삭제
			function callDeletePostModal(e){
				let pNum = e.target.parentElement.dataset.postunino;
				console.log(pNum);
				let bNum = '[[${brdUniNo}]]'
				document.getElementById('deleteBtn').addEventListener('click', function(e){

					fetch('http://localhost:80/modu/postDelete/' + pNum)
					//.then(resolve => resolve.json())
					.then(data => {
						console.log(data);
						window.location.href = 'http://localhost:80/modu/postList?brdUniNo=' + bNum;
					})
					.catch(err => console.log(err)); 
				})
			
			}

			//공지리스트
			function notiPostList(){
				let bNum = '[[${brdUniNo}]]';
				let notiPlace = document.querySelector('.notiPosts');
				//console.log(notiPlace);
				fetch('http://localhost:80/modu/notiPost/' + bNum)
				.then(resolve => resolve.json())
				.then(data => {
					//console.log(data);
					notiPlace.innerHTML = '';
					data.forEach(noti => {
						let liTag = document.createElement('li');
						let aTag = document.createElement('a');
						aTag.setAttribute('href', '#'+noti.postUniNo);
						aTag.textContent = noti.ttl;
						liTag.append(aTag);
						notiPlace.appendChild(liTag);
					})
				})
			}
			//공지리스트호출
			notiPostList();

			//공지등록on/off
			let postDDMList = document.querySelectorAll('.postDDM');
			postDDMList.forEach(postDDM => {
				let notiBTN = postDDM.children[1];
				notiBTN.addEventListener('click', function(e){
					e.preventDefault();
					let pNum = e.target.parentElement.dataset.postunino;
					let postInfo = {};
					if(notiBTN.textContent == '공지등록'){
						postInfo['postUniNo'] = pNum;
						postInfo['notiYn'] = 'O';
						fetch('http://localhost/modu/setPostNoti',{
							method : 'post',
							headers : {
								'content-type' : 'application/json'
							},
							body : JSON.stringify(postInfo)
						})
						.then(result => result.json())
						.then(data => {
							//console.log(data);
							//공지리스트
							notiPostList();
						})
						.catch(err => console.log(err))
					}else{
						postInfo['postUniNo'] = pNum;
						postInfo['notiYn'] = 'X';
						fetch('http://localhost/modu/setPostNoti',{
							method : 'post',
							headers : {
								'content-type' : 'application/json'
							},
							body : JSON.stringify(postInfo)
						})
						.then(result => result.json())
						.then(data => {
							//console.log(data);
							//공지리스트
							notiPostList();
						})
						.catch(err => console.log(err))
					}
				}) 
			})

			//댓글등록알림ON/OFF
			postDDMList.forEach(postDDM => {
				let reOnOffBTN = postDDM.children[2];
				//console.log(reOnOffBTN.textContent);
				reOnOffBTN.addEventListener('click', function(e){
					e.preventDefault();
					let pNum = e.target.parentElement.dataset.postunino;
					let postInfo = {};
					if(reOnOffBTN.textContent == '댓글알림ON'){
						postInfo['postUniNo'] = pNum;
						postInfo['replyArmYn'] = 'Y';
				
						fetch('http://localhost/modu/setPostReply',{
							method : 'post',
							headers : {
								'content-type' : 'application/json'
							},
							body : JSON.stringify(postInfo)
						})
						.then(result => result.json())
						.then(data => {
							//console.log(data);
						})
						.catch(err => console.log(err))
					}else{
						postInfo['postUniNo'] = pNum;
						postInfo['replyArmYn'] = 'N';
				
						fetch('http://localhost/modu/setPostReply',{
							method : 'post',
							headers : {
								'content-type' : 'application/json'
							},
							body : JSON.stringify(postInfo)
						})
						.then(result => result.json())
						.then(data => {
							//console.log(data);
						})
						.catch(err => console.log(err))
					}
				}) 
			})
		</script>
		
<script> <!-- 게시글 즐겨찾기 등록 -->
	//console.log($('.bm').text());
function PostBm(){
	console.log(event.target.id);
   	let postNo = event.target.id;
	let particiMembUniNo = '[[${session.particiMembUniNo}]]';
	let data = {
			'particiMembUniNo' : particiMembUniNo,
			'postUniNo' : postNo
	}
	fetch('/modu/BmInsert',{
		method:'POST',
		headers : {
			'content-type' : 'application/json'
		},
		body : JSON.stringify(data)
	})
	.then(response => response.json())
	.then(data => {
		console.log(data);
		location.href='postList?brdUniNo='+'[[${brdUniNo}]]';
	})
}
</script>

<script>
fetch('/modu/bmList')
.then(response => response.json()) 
.then(data => {
  console.log(data); 
  
  for (const item of data) {
    console.log(item);

    let bmUniNo = item.bmUniNo; 
    console.log('즐찾 번호 : '+bmUniNo); 

    let particiMembUniNo = item.particiMembUniNo;
    console.log('참여자 번호 : '+particiMembUniNo);

  }
})
.catch(err => { 
  console.error(err); 
});
</script>
	</div>
</div>
</body>
<!-- <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
<script src="assets/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/main.js"></script> -->
</html>