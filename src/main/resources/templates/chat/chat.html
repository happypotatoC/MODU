<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{index}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="http://localhost/modu/assets/css/bootstrap.css">
<link rel="stylesheet" href="http://localhost/modu/assets/css/widgets/chat.css">

<link rel="stylesheet" href="http://localhost/modu/assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
<link rel="stylesheet" href="http://localhost/modu/assets/vendors/bootstrap-icons/bootstrap-icons.css">
<link rel="stylesheet" href="http://localhost/modu/assets/css/app.css">
<link rel="shortcut icon" href="http://localhost/modu/assets/images/favicon.svg" type="image/x-icon"> 

</head>
<body>
	<div layout:fragment="content">

		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script	src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
		<section class="section">
			<div class="row">
				<div class="col-md-10">
					<div class="card">
						<div class="card-header">
							<div class="media d-flex align-items-center">
								<div class="avatar me-3">
									<img src="http://localhost/modu/assets/images/faces/1.jpg" alt="" srcset=""> <span
										class="avatar-status bg-success"></span>
								</div>
								<div class="name flex-grow-1">
									<h6 class="mb-0">[[${info.chatParticiMembUniNo}]]</h6>
									<span class="text-xs">[[${info.chatrNo}]]</span>
									[[${session.chatrNo}]]
								</div>
								<button class="btn btn-sm">
									<i data-feather="x"></i>
								</button>
							</div>
						</div>
						<div class="card-body pt-4 bg-grey">
							<div class="chat-content">
								<!-- <div class="chat">
									<div class="chat-body">
										<div class="chat-message">Hi Alfy, how can i help you?</div>
									</div>
								</div>
								<div class="chat chat-left">
									<div class="chat-body">
										<div class="chat-message">I'm looking for the best admin
											dashboard template</div>
										<div class="chat-message">With bootstrap certainly</div>
									</div>
								</div>
								<div class="chat">
									<div class="chat-body">
										<div class="chat-message">I recommend you to use Mazer
											Dashboard</div>
									</div>
								</div>
								<div class="chat chat-left">
									<div class="chat-body">
										<div class="chat-message">That"s great! I like it so much :)</div>
									</div>
								</div> -->
							</div>
						</div>
						<div class="card-footer">
							<div
								class="message-form d-flex flex-direction-column align-items-center">
								<a href="http://" class="black"><i data-feather="smile"></i></a>
								<div class="d-flex flex-grow-1 ml-4">
									<input type="text" id="sendMsg" name="cntn" class="form-control" placeholder="Type your message..">
									<button type="button" id="sendMsgBtn">보내기</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<script>
			

			//채팅메세지리스트
			function showChatMsgList(){
				let msgPlace = document.getElementsByClassName('chat-content')[0];
				let chatrNo = '[[${session.chatrNo}]]'
				let chatWriter = '[[${session.chatParticiMembUniNo}]]';

				fetch("http://localhost/modu/msgList/" + chatrNo)
				.then(resolve => resolve.json())
				.then(data => {
					msgPlace.innerHTML = ''; // 지우고다시리스트
					data.forEach(msg => {
						
						if(msg.chatParticiMembUniNo == chatWriter){	

							//내가 쓴 채팅
							let cdiv = document.createElement('div');
							cdiv.setAttribute('class', 'chat');
							msgPlace.append(cdiv);

							let cbdiv = document.createElement('div');
							cbdiv.setAttribute('class', 'chat-body');
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

							let cmdiv = document.createElement('div');
							cmdiv.setAttribute('class', 'chat-message');
							cmdiv.textContent = msg.cntn;
							cbdiv.append(cmdiv);
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

						}else{

							//상대가 쓴 채팅
							let cdiv = document.createElement('div');
							cdiv.setAttribute('class', 'chat chat-left');
							msgPlace.append(cdiv);

							let cbdiv = document.createElement('div');
							cbdiv.setAttribute('class', 'chat-body');
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

							let cmdiv = document.createElement('div');
							cmdiv.setAttribute('class', 'chat-message');
							cmdiv.textContent = msg.cntn;
							cbdiv.append(cmdiv);
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

						}
					});
				})
			}
			showChatMsgList();

			document.getElementById('sendMsgBtn').addEventListener('click', sendMessage);
			
			//웹소켓
			let chatrNo = '[[${session.chatrNo}]]'
			let chatWriter = '[[${session.chatParticiMembUniNo}]]';
			let cntn = document.getElementById('sendMsg').value;
			
			// WebSocket 연결 설정
			const stompClient = new StompJs.Client({
    		brokerURL: 'ws://localhost/modu/socketserver' // WebSocket 서버 URL
			});

			// 페이지 로드 시 웹소켓 연결
			window.addEventListener("load", function(event) {
				stompClient.activate();
			});

			// 연결 성공 시
			stompClient.onConnect = (frame) => {
					console.log('Connected: ' + frame);
					stompClient.subscribe('/sub/chat/msg/'+chatrNo, (chatMsg) => {

					//console.log(chatMsg.body)
					showChatMsg(JSON.parse(chatMsg.body));
					});
			};

			stompClient.onWebSocketError = (error) => {
					console.error('Error with websocket', error);
			};

			stompClient.onStompError = (frame) => {
					console.error('Broker reported error: ' + frame.headers['message']);
					console.error('Additional details: ' + frame.body);
			};

			// 보내기버튼누르면발생하는이벤트
			function sendMessage() {

				let chatrNo = '[[${session.chatrNo}]]'
				let chatWriter = '[[${session.chatParticiMembUniNo}]]';
				let cntn = document.getElementById('sendMsg').value;
					// 보낸 메세지 발행
					stompClient.publish({
							destination: "/pub/chat/msg",
							body: JSON.stringify({'chatrNo': chatrNo,
																		'chatParticiMembUniNo' : chatWriter,
																		'cntn': cntn})
					});

					//console.log(cntn);
					// 보낸 메세지 DB에 저장
					let wantSend = {};
					wantSend['cntn'] = cntn;

					fetch("http://localhost/modu/chatMsg",{
						method : 'post',
							headers : {
								'content-type' : 'application/json'
							},
							body : JSON.stringify(wantSend)
					})
					.then(result => result.json())
					.then(data => {
						console.log(data)
					})
					.catch(err => console.log(err))
			}

			function showChatMsg(chatMsg) {
				let msgPlace = document.getElementsByClassName('chat-content')[0];
				// let chatrNo = '[[${session.chatrNo}]]'
				let chatWriter = '[[${session.chatParticiMembUniNo}]]';
				// let cntn = document.getElementById('sendMsg').value;

				if(chatMsg.chatParticiMembUniNo == chatWriter){	

					//내가 쓴 채팅
					let cdiv = document.createElement('div');
					cdiv.setAttribute('class', 'chat');
					msgPlace.append(cdiv);

					let cbdiv = document.createElement('div');
					cbdiv.setAttribute('class', 'chat-body');
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

					let cmdiv = document.createElement('div');
					cmdiv.setAttribute('class', 'chat-message');
					cmdiv.textContent = chatMsg.cntn;
					cbdiv.append(cmdiv);
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

				}else{

					//상대가 쓴 채팅
					let cdiv = document.createElement('div');
					cdiv.setAttribute('class', 'chat chat-left');
					msgPlace.append(cdiv);

					let cbdiv = document.createElement('div');
					cbdiv.setAttribute('class', 'chat-body');
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

					let cmdiv = document.createElement('div');
					cmdiv.setAttribute('class', 'chat-message');
					cmdiv.textContent = chatMsg.cntn;
					cbdiv.append(cmdiv);
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

				}
			}


			//채팅방 떠나면 웹소켓 연결 끊음
			function disconnectWebSocket() {
					stompClient.deactivate();
			}
			window.addEventListener("beforeunload", disconnectWebSocket);
			
		</script>
		
		<script	src="http://localhost/modu/assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
		<script src="http://localhost/modu/assets/js/bootstrap.bundle.min.js"></script>
		<script src="http://localhost/modu/assets/js/main.js"></script> 
	</div>
</body>
</html>
