<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="com.modu.app.prj.prj.mapper.PrjMapper">
 
 	<!-- 프로젝트 생성 -->
 	<insert id="insertPrj" parameterType="PrjVO" statementType="CALLABLE">
 		CALL
 			create_prj(
 					   #{prjNm},
 					   #{membUniNo}
 					  )
 	</insert>
 	
 	<!-- 프로젝트 리스트 조회 -->
 	<select id="selectPrjList" parameterType="String" resultType="PrjVO">
 		SELECT *
 		
		  FROM prj p 
		  JOIN prj_partici_memb pm 
		    on p.prj_uni_no = pm.prj_uni_no
          JOIN memb m 
            ON pm.memb_uni_no = m.memb_uni_no 
          JOIN cmmn c 
            ON c.cd_no=pm.grd
          
		 WHERE pm.partici_yn = 'Y'
		   AND m.memb_uni_no = #{membUniNo}
 	</select>
 	
 	<!-- 프로젝트 이름 변경 -->
 	<update id="updatePrjNm" parameterType="PrjVO">
 		UPDATE prj
		   SET prj_nm = #{prjNm}
		 WHERE prj_uni_no = #{prjUniNo}
 	</update>
 	
 	<!-- 프로젝트 구독 취소 -->
 	<update id="updatePrjSubsp">
 	
 	</update>
 	
 	<!-- 프로젝트 참여 회원 리스트 -->
 	<select id="selectPrjParti" parameterType="PrjVO" resultType="PrjVO">
 		SELECT PARTICI_MEMB_UNI_NO, 
				PRJ_UNI_NO,
				MEMB_UNI_NO, 
				ATT_NO, 
				NNM,
				GRD,
				FIND_CODE_NAME(GRD) AS CD, 
				PARTICI_YN,    
				PRJ_PUBC_ID , 
				DEPT  , 
				POS   
				
		  FROM prj_partici_memb pm
		  
		  WHERE pm.prj_uni_no = #{prjUniNo}
			AND pm.partici_yn = 'Y'
		    ORDER BY pm.partici_memb_uni_no
 	</select>

 	<!-- 프로젝트 참여번호 세션 -->
 	<select id="prjSession" resultType="PrjVO">
		SELECT *
		  FROM prj_partici_memb
		  WHERE prj_uni_no = #{prjUniNo}
			AND memb_uni_no = #{membUniNo}
	</select>
 	
 	<!-- 등급 공통코드 -->
 	<select id="grdCmmn" resultType="PrjVO">
 		select *
		from cmmn
		where grp_cd = '등급'
 	</select>
 	
 	<!-- 프로젝트 참여 회원 등급변경 -->
 	<update id="updateGrade" parameterType="PrjVO">
  		UPDATE prj_partici_memb
		SET grd = #{grd}
		WHERE partici_memb_uni_no = #{particiMembUniNo}
  	</update>
	
	<!-- 프로젝트 회원 탈퇴 -->
	<update id="kickPrjParti" parameterType="PrjVO" statementType="CALLABLE">
		CALL
			kick_partici_memb(#{particiMembUniNo}, #{kickResn})
	</update>
	
	<!-- 프로젝트 삭제 -->
 	<delete id="deletePrj" parameterType="String">
 		DELETE FROM prj
 		WHERE  prj_uni_no = #{prjUniNo}
 	</delete>
 	
 	<!--회원의 프로젝트 내 등급-->
 	<select id="selectMemInfo" parameterType="PrjVO" resultType="PrjVO">
		SELECT PARTICI_MEMB_UNI_NO, 
				PRJ_UNI_NO,
				MEMB_UNI_NO, 
				ATT_NO, 
				NNM,
				GRD,
				FIND_CODE_NAME(GRD) AS CD, 
				PARTICI_YN,    
				PRJ_PUBC_ID , 
				DEPT  , 
				POS  
		from prj_partici_memb pm left join cmmn c on c.cd_no=pm.grd
		WHERE pm.partici_yn = 'Y'
		<if test="membUniNo != null and !membUniNo.equals('')">
			AND pm.memb_uni_no = #{membUniNo}		
		</if>
		<if test="cd != null and !cd.equals('')">
			AND c.cd = #{cd}
		</if>
		and pm.prj_uni_no = #{prjUniNo}
 	</select>
 	
 	<!-- 프로젝트참여회원수 -->
 	<select id="selectPrjMemCnt" parameterType="String" resultType="int">
 		SELECT count(*)
		FROM prj_partici_memb
		WHERE prj_uni_no = #{prjUniNo}
		AND partici_yn = 'Y'
 	</select>
 	
 	<!-- 프로젝트 정보 -->
 	<select id="selectPrjInfo" parameterType="String" resultType="PrjVO">
	 	select * 
		from prj
		WHERE prj.prj_uni_no = #{prjUniNo}
 	</select>
 	
 </mapper>