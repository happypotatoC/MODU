<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{index}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/css/bootstrap.css">
<link rel="stylesheet" href="assets/css/widgets/chat.css">

<link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
<link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
<link rel="stylesheet" href="assets/css/app.css">
<link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon"> 

</head>
<body>
	<div layout:fragment="content">
		<!-- start of 웹소켓용 -->
		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script	src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
		<!-- end of 웹소켓용 -->
		<section class="section">
			<div class="row">
				<div class="col-md-10 col-sm-12 mx-auto">
					<div class="card">
						<div class="card-header">
							<div class="media d-flex align-items-center">
								<div class="avatar me-3">
									<img src="assets/images/faces/1.jpg" alt="" srcset=""> <span
										class="avatar-status bg-success"></span>
								</div>
								<div class="name flex-grow-1">
									<h6 class="mb-0">[[${info.chatParticiMembUniNo}]]</h6>
									<span class="text-xs">[[${info.chatrNo}]]</span>
									[[${session.chatrNo}]]
								</div>
								<div class="dropdown">
										<button class="btn btn-primary dropdown-toggle me-1" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
												...
										</button>
										<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
												<a class="dropdown-item" href="#">채팅방초대(아직안됨)</a>
												<a class="dropdown-item" id="calloneChatr" data-bs-toggle="modal" data-bs-target="#changeChatrNm">채팅방명변경</a>
												<a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#leaveChatr">채팅방나가기</a>
										</div>
								</div>
							</div>
						</div>
						<div class="card-body pt-4 bg-grey">
							<div class="chat-content">
								<!-- <div class="chat">
									<div class="chat-body">
										<div class="chat-message">Hi Alfy, how can i help you?</div>
									</div>
								</div>
								<div class="chat chat-left">
									<div class="chat-body">
										<div class="chat-message">I'm looking for the best admin
											dashboard template</div>
										<div class="chat-message">With bootstrap certainly</div>
									</div>
								</div>
								<div class="chat">
									<div class="chat-body">
										<div class="chat-message">I recommend you to use Mazer
											Dashboard</div>
									</div>
								</div>
								<div class="chat chat-left">
									<div class="chat-body">
										<div class="chat-message">That"s great! I like it so much :)</div>
									</div>
								</div> -->
							</div>
						</div>
						<div class="card-footer">
							<div class="message-form d-flex flex-direction-column align-items-center">
								<a href="http://" class="black"><i data-feather="smile"></i></a>
								<div class="d-flex flex-grow-1 ml-4">
									<input type="text" id="sendMsg" name="cntn" class="form-control" placeholder="Type your message..">
									<div class="buttons">
										<button type="button" id="sendMsgBtn" class="btn btn-primary rounded-pill">send</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- start of MODALS -->
				<!-- start of 채팅방 나가기 모달 -->
				<div class="modal fade text-left" id="leaveChatr" tabindex="-1"	role="dialog" aria-labelledby="myModalLabel160"	aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
						<div class="modal-content">
							<div class="modal-header bg-primary">
								<h5 class="modal-title white" id="myModalLabel160">채팅방 나가기</h5>
								<button type="button" class="close" data-bs-dismiss="modal"	aria-label="Close">
									<i data-feather="x"></i>
								</button>
							</div>
							<div class="modal-body">
								채팅방을 나가시면 다시 초대 받지 않는 한<br> 동일한 채팅방에 참여하실 수 없습니다. <br>이 채팅방에서 나가시겠습니까? 
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-light-secondary"	data-bs-dismiss="modal">
									<i class="bx bx-x d-block d-sm-none"></i> 
									<span class="d-none d-sm-block">취소</span>
								</button>
								<button id="leaveChatrBtn" type="button" class="btn btn-primary ml-1" data-bs-dismiss="modal">
									<i class="bx bx-check d-block d-sm-none"></i> 
									<span class="d-none d-sm-block">확인</span>
								</button>
							</div>
						</div>
					</div>
				</div>
				<!-- end of 채팅방 나가기 모달 -->
				
				<!-- start of 채팅방명변경 모달 -->
				<div class="modal fade text-left" id="changeChatrNm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h4 class="modal-title" id="myModalLabel33">채팅방명변경</h4>
								<button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
									<i data-feather="x"></i>
								</button>
							</div>
							<form action="updateChatrNm" method="POST" id="FormEvent">
								<div class="modal-body">
									<div id="chatrNamePlace" class="form-group">
										<input id="chatrNm" name="chatrNm" type="text" class="form-control">
									</div>
									<div class="form-group">
										<input id="chatParticiMembUniNo" name="chatParticiMembUniNo" th:value="${session.chatParticiMembUniNo}" type="text" class="form-control"> 
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
											<i class="bx bx-x d-block d-sm-none"></i> <span class="d-none d-sm-block">닫기</span>
										</button>
										<button id="formbtn" type="button" class="btn btn-primary ml-1" data-bs-dismiss="modal" onclick="updateChatr()">
											<i class="bx bx-check d-block d-sm-none"></i> <span class="d-none d-sm-block">변경</span>
										</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!-- end of 채팅방명변경 모달 -->
		<!-- end of MODALS -->
		
		<script>
			
			//채팅메세지리스트
			function showChatMsgList(){
				let msgPlace = document.getElementsByClassName('chat-content')[0];
				let chatrNo = '[[${session.chatrNo}]]'
				let chatWriter = '[[${session.chatParticiMembUniNo}]]';

				fetch("/modu/msgList/" + chatrNo)
				.then(resolve => resolve.json())
				.then(data => {
					msgPlace.innerHTML = ''; // 지우고다시리스트
					data.forEach(msg => {
						
						if(msg.chatParticiMembUniNo == chatWriter){	

							//내가 쓴 채팅
							let cdiv = document.createElement('div');
							cdiv.setAttribute('class', 'chat');
							msgPlace.append(cdiv);

							let cbdiv = document.createElement('div');
							cbdiv.setAttribute('class', 'chat-body');
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

							let cmdiv = document.createElement('div');
							cmdiv.setAttribute('class', 'chat-message');
							cmdiv.textContent = msg.cntn;
							cbdiv.append(cmdiv);
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

						}else{

							//상대가 쓴 채팅
							let cdiv = document.createElement('div');
							cdiv.setAttribute('class', 'chat chat-left');
							msgPlace.append(cdiv);

							let cbdiv = document.createElement('div');
							cbdiv.setAttribute('class', 'chat-body');
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

							let cmdiv = document.createElement('div');
							cmdiv.setAttribute('class', 'chat-message');
							cmdiv.textContent = msg.cntn;
							cbdiv.append(cmdiv);
							cdiv.append(cbdiv);
							msgPlace.append(cdiv);

						}
					});
				})
			}
			showChatMsgList();
			
			//채팅방 나가기
			document.getElementById('leaveChatrBtn').addEventListener('click', function(){
				let chatMemb = '[[${session.chatParticiMembUniNo}]]';
				let prjUniNo = '[[${session.prjUniNo}]]';

				fetch("/modu/leaveChatr/"+chatMemb)
				.then(resolve => resolve.json())
				.then(data => {
					console.log(data);
					window.location.href = '/modu/main?prjUniNo='+prjUniNo;
				})
				.catch(err => console.log(err))
			})

			//채팅방명변경폼
			document.getElementById('calloneChatr').addEventListener('click', function(){
				let chatMemb = '[[${session.chatParticiMembUniNo}]]';
				fetch("/modu/updateChatr/" + chatMemb)
				.then(resolve => resolve.json())
				.then(data => {
					//console.log(data);
					document.getElementById('chatrNm').value = data.chatrNm;
				})
			})

			//채팅방명변경
			function updateChatr(){
				let newChatrNm = document.getElementById('chatrNm').value;
				let changeNm = {};
				changeNm['chatrNm'] = newChatrNm;

				fetch("/modu/updateChatrNm",{
					method:'post',
					headers : {
						'content-type' : 'application/json'
					},
					body : JSON.stringify(changeNm)
				})
				.then(result => result.json())
				.then(data => {
					console.log(data);
				})
			}

			//보내기버튼누르면 sendMessage호출
			document.getElementById('sendMsgBtn').addEventListener('click', sendMessage);
			
			//start of 웹소켓
			let chatrNo = '[[${session.chatrNo}]]'
			let chatWriter = '[[${session.chatParticiMembUniNo}]]';
			let cntn = document.getElementById('sendMsg').value;
			
			// WebSocket 연결 설정
			const stompClient = new StompJs.Client({
    		brokerURL: 'ws://192.168.0.27/modu/socketserver' // WebSocket 서버 URL
			});

			// 페이지 로드시 웹소켓 연결
			window.addEventListener("load", function(event) {
				stompClient.activate();
			});

			// 연결 성공시
			stompClient.onConnect = (frame) => {
					//console.log('Connected: ' + frame);
					stompClient.subscribe('/sub/chat/msg/'+chatrNo, (chatMsg) => {
					//console.log(chatMsg.body)
					showChatMsg(JSON.parse(chatMsg.body));
					});
			};

			//에러
			stompClient.onWebSocketError = (error) => {
					console.error('Error with websocket', error);
			};

			stompClient.onStompError = (frame) => {
					console.error('Broker reported error: ' + frame.headers['message']);
					console.error('Additional details: ' + frame.body);
			};

			// 보내기버튼누르면발생하는이벤트
			function sendMessage() {

				let chatrNo = '[[${session.chatrNo}]]'
				let chatWriter = '[[${session.chatParticiMembUniNo}]]';
				let cntn = document.getElementById('sendMsg').value;

					// 보낸 메세지 발행
					stompClient.publish({
							destination: "/pub/chat/msg",
							body: JSON.stringify({'chatrNo': chatrNo,
												  'chatParticiMembUniNo' : chatWriter,
												  'cntn': cntn})
					});

					// 보낸 메세지 DB에 저장
					let wantSend = {};
					wantSend['cntn'] = cntn;

					fetch("/modu/chatMsg",{
						method : 'post',
							headers : {
								'content-type' : 'application/json'
							},
							body : JSON.stringify(wantSend)
					})
					.then(result => result.json())
					.then(data => {
						//console.log(data)
					})
					.catch(err => console.log(err))
			}

			//채팅메세지추가
			function showChatMsg(chatMsg) {
				let msgPlace = document.getElementsByClassName('chat-content')[0];
				let chatWriter = '[[${session.chatParticiMembUniNo}]]';

				if(chatMsg.chatParticiMembUniNo == chatWriter){	

					//내가 쓴 채팅
					let cdiv = document.createElement('div');
					cdiv.setAttribute('class', 'chat');
					msgPlace.append(cdiv);

					let cbdiv = document.createElement('div');
					cbdiv.setAttribute('class', 'chat-body');
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

					let cmdiv = document.createElement('div');
					cmdiv.setAttribute('class', 'chat-message');
					cmdiv.textContent = chatMsg.cntn;
					cbdiv.append(cmdiv);
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

				}else{

					//상대가 쓴 채팅
					let cdiv = document.createElement('div');
					cdiv.setAttribute('class', 'chat chat-left');
					msgPlace.append(cdiv);

					let cbdiv = document.createElement('div');
					cbdiv.setAttribute('class', 'chat-body');
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

					let cmdiv = document.createElement('div');
					cmdiv.setAttribute('class', 'chat-message');
					cmdiv.textContent = chatMsg.cntn;
					cbdiv.append(cmdiv);
					cdiv.append(cbdiv);
					msgPlace.append(cdiv);

				}
			}

			//채팅방 떠나면 웹소켓 연결 끊음
			function disconnectWebSocket() {
					stompClient.deactivate();
			}
			window.addEventListener("beforeunload", disconnectWebSocket);
			
			//end of 웹소켓
			
		</script>
		
		<script	src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
		<script src="assets/js/bootstrap.bundle.min.js"></script>
		
	</div>
</body>
</html>
